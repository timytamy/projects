#!/bin/sh

KERNEL_RELEASE=`uname -r`

if [ "$PWD" ]
then DMXROOT=$PWD
else DMXROOT=`pwd`
fi

if [ "$CONFIG" ]
then true # do nothing
elif [ -f kernelconfig ]
then CONFIG=kernelconfig
elif [ -f /proc/config.gz ]
then zcat /proc/config.gz > /tmp/dmx_config
     CONFIG=/tmp/dmx_config
elif [ -f /lib/modules/$KERNEL_RELEASE/build/.config ]
then CONFIG=/lib/modules/$KERNEL_RELEASE/build/.config
elif [ -f /usr/src/linux-$KERNEL_RELEASE/.config ]
then CONFIG=/usr/src/linux-$KERNEL_RELEASE/.config
elif [ -f /usr/src/linux/.config ]
then CONFIG=/usr/src/linux/.config
else
    echo "could not find any of CONFIG=, kernelconfig, /proc/config.gz or /lib/modules/$KERNEL_RELEASE/build/.config, /usr/src/linux-$KERNEL_RELEASE/.config or /usr/src/linux/.config"
    echo "please provide a valid 2.6 linux kernel config file"
    exit 1
fi

cp -f "$CONFIG" /tmp/dmxconfig.mk

PREFIX=/usr
echo "DMXPREFIX=$PREFIX" >> /tmp/dmxconfig.mk

MODULEINSTALLPATH=/lib/modules/$KERNEL_RELEASE/extra
echo "MODULEINSTALLPATH=$MODULEINSTALLPATH" >> /tmp/dmxconfig.mk

echo "VERSIONMAJOR=2" >> /tmp/dmxconfig.mk
echo "VERSIONMINOR=6" >> /tmp/dmxconfig.mk
echo "DMXVERSION=2.6" >> /tmp/dmxconfig.mk

echo "DMXOUTMINOR=223" >> /tmp/dmxconfig.mk
echo "DMXINMINOR=224" >> /tmp/dmxconfig.mk

echo "AS31=$DMXROOT/tools/as31-unix" >> /tmp/dmxconfig.mk

echo "CFLAGS+=-Wall -O2 -I$DMXROOT/include" >> /tmp/dmxconfig.mk
echo "LDFLAGS+=-L$DMXROOT/libs" >> /tmp/dmxconfig.mk

if [ -f /usr/include/gpm.h -o -f /usr/local/include/gpm.h ] ; then
    echo "CONFIG_HAVE_GPM=1" >> /tmp/dmxconfig.mk
fi

echo dmx4linux successfully configured
exit 0
